<!DOCTYPE html>
<html>
  <head>
    <meta charset='utf-8'>
    <meta name="generator" content=
    "HTML Tidy for HTML5 for Mac OS X version 5.4.0">
    <title>
      Tokenized Card Payment
    </title>
    <script src='https://www.w3.org/Tools/respec/respec-w3c-common' async
    class='remove'></script>
    <script src='utils.js' class='remove'></script>
    <script class='remove'>
      var respecConfig = {
          github: "https://github.com/w3c/webpayments-methods-tokenization/",
          shortName:  "tokenized-card",
          edDraftURI:   "https://w3c.github.io/webpayments-methods-tokenization/",
          specStatus: "unofficial",
          testSuiteURI: "https://w3c-test.org/payment-method-tokenized-card/",
          editors: [
                {
                    name:      "Keyur Patel",
                    company:   "Mastercard"
                },
                {
                    name:      "Ian Jacobs",
                    company:   "W3C"
                },
      ],
      formerEditors: [
                {   name:       "Kevin Hurley",
                    company:    "Facebook"
                },
                {
                    name:      "Roy McElmurry",
                    company:   "Facebook"
                }
         ],
          useExperimentalStyles: true,
         license:      "w3c-software-doc",
         wg:           "Web Payments Working Group",
         wgURI:        "https://www.w3.org/Payments/WG/",
         wgPublicList: "public-payments-wg",
         issueBase:    "https://github.com/w3c/webpayments-methods-tokenization/issues/",
        localBiblio: {
          "card-network-ids": {
            "href": "https://www.w3.org/Payments/card-network-ids",
            "publisher": "W3C",
            "title": "Card Network Identifiers Approved for use with Payment Request API"
          },
          "EMVCO-TOKENIZATION": {
            "href": "https://www.emvco.com/emv-technologies/payment-tokenisation/",
            "publisher": "EMVCo",
            "title": "EMV® Payment Tokenisation Specification – Technical Framework"
          },
          "EMVCO-3DS": {
            "href": "https://www.emvco.com/emv-technologies/3d-secure/",
            "publisher": "EMVCo",
            "title": "EMV® 3-D Secure"
          },
          "webpayments-crypto": {
            "href": "https://w3c.github.io/webpayments-crypto/",
            "publisher": "W3C",
            "title": "Payment Method Encryption"
          }
        },
      };
    </script>
    <style>
    dt { margin-top: 0.75em; }
    table { margin-top: 0.75em; border-collapse:collapse; border-style:hidden hidden none hidden }
    table thead { border-bottom:solid }
    table tbody th:first-child { border-left:solid }
    table td, table th { border-left:solid; border-right:solid; border-bottom:solid thin; vertical-align:top; padding:0.2em }
    li { margin-top: 0.5em; margin-bottom: 0.5em;}
    </style>
  </head>
  <body>
    <section id="abstract">
      <p>
        This specification defines a Payment Method used by the PaymentRequest
        API [[!payment-request]] to support tokenized card payments.
      </p>
    </section>
    <section id='sotd'>
      <p>
        The working group maintains <a href=
        "https://github.com/w3c/webpayments-methods-tokenization/issues">a list
        of all bug reports that the group has not yet addressed</a>. Pull
        requests with proposed specification text for outstanding issues are
        strongly encouraged.
      </p>
    </section>
    <section class="informative">
      <h2>
        Introduction
      </h2>
      <p>
        A network token replaces the number embossed on a credit or debit card
        —the primary account number or PAN— with surrogate data. This
        substitution offers several security benefits:
      </p>
      <ul>
        <li>By storing tokens instead of the PAN, merchants can reduce the risk
        of fraud due to data compromise.
        </li>
        <li>Tokens may include "domain controls" that reduce opportunities for
        misuse, for example by limiting usage to a given site, transaction, or
        time period.
        </li>
        <li>Some tokens may be accompanied by per-transaction (or, "dynamic")
        data such as a ‘cryptogram’, ‘authentication value’ or ‘card
        verification value’ to enable validation of authorized use.
        </li>
      </ul>
      <p>
        Network tokens offer additional benefits as well:
      </p>
      <ul>
        <li>If a user's card number is lost, stolen or replaced, a merchant may
        still use a stored token associated with the card for future
        transactions.
        </li>
        <li>A merchant can reduce compliance burden in partnership with a
        payment service provider though the use of <a>Token Reference ID</a>s:
        the payment service provider stores the token while the merchant stores
        the <a>Token Reference ID</a>.
        </li>
      </ul>
      <p>
        Payment networks (e.g., American Express, China Union Pay, Discover,
        JCB, Mastercard, and Visa) and issuing banks offer services that
        provide the tokens described by this specification. Data requirements
        are drawn from the EMVCo specifications [[!EMVCO-TOKENIZATION]] and
        [[!EMVCO-3DS]].
      </p>
      <p>
        This document describes how to connect these service providers to the
        Payment Request [[payment-request]] ecosystem so that merchants can
        request network and issuer tokens, and users can use payment handlers
        that request these tokens from service providers.
      </p>
    </section>
    <section id="exampleData">
      <h2>
        Examples
      </h2>
      <section>
        <h3>
          Tokenized-Card Request Example
        </h3>
        <pre class="example">
const methodData = [{
  supportedMethods: ['tokenized-card'],
  data: {
    supportedNetworks: ['mastercard','visa', 'amex', 'discover', 'jcb','unionpay'],
    supportedTypes: ['credit','debit'],
    usageType: 'one-time',
    payeeID: '234987',
    keyProviderURL: 'https://pspKeyProvider.example/tokenizedCardPublicKey',
  }
}];

const details = {
  displayItems: [
    {
      label: "Sub-total",
      amount: { currency: "USD", value: "55.00" },
    },
    {
      label: "Sales Tax",
      amount: { currency: "USD", value: "5.00" },
    },
  ],
  total: {
    label: "Total due",
    // The total is USD$65.00 here because we need to
    // add shipping (below). The selected shipping
    // costs USD$5.00.  
    amount: { currency: "USD", value: "65.00" },
  },
};

new PaymentRequest(methodData, details);
        </pre>
      </section>
      <section>
        <h3>
          Tokenized-Card Response Example
        </h3>
        <p>
          This example shows some fictitious Mastercard-specific response data.
        </p>
        <div class="example">
          <pre>
          {
          displayLast4: "***6789",
          displayExpiryMonth: "02",
          displayExpiryYear: "22",
          displayNetwork: "mastercard",
          encryptedDetails: "QWxobHZ4bU4yWkt1QUFFU05GWjRHb0FCRkE9PQ==", 
          }
        </pre>
          <p>
            When decrypted, the <code>encryptedDetails</code> data would be:
          </p>
          <pre>
          {
          cardNumber: "5413339000001513",
          expiryMonth: "12",
          expiryYear: "20",
          cryptogram: "AlhlvxmN2ZKuAAESNFZ4GoABFA==",
          typeOfCryptogram: "UCAF", // "Universal Card Authentication Field"
          trid: "59812345678",
          eci: "242", // Authorization and final transaction request with UCAF data
          }
        </pre>
        </div>
      </section>
    </section>
    <section class="informative">
      <h2 id="use-cases-and-flows">
        Use Cases and Flows
      </h2>
      <p>
        This specification is designed to address these primary use cases:
      </p>
      <ul>
        <li>Single transaction
        </li>
        <li>Recurring payments (same token, all subsequent transactions
        approved through an initial agreement with the payer)
        </li>
        <li>Card-on-file payments (same token, subsequent transactions approved
        individually by the payer)
        </li>
      </ul>
      <p>
        See the <a>TokenUsageType</a> for more information.
      </p>
      <p>
        For these use cases, the individual payment methods support different
        flows:
      </p>
      <dl>
        <dt>
          tokenized-card
        </dt>
        <dd>
          This payment method covers several flows:
          <ul>
            <li>One-time usage of a token
            </li>
            <li>Recurring payments with a token
            </li>
            <li>Card-on-file use cases with the following assumptions. The
            payee seeks a token and does not yet have any card information from
            the payer. The response data includes a token, cryptogram, and
            other information sufficient for an authorization request.
            </li>
          </ul>
        </dd>
        <dt>
          token-reference
        </dt>
        <dd>
          This payment method covers the same flows as
          <code>tokenized-card</code> but relies on the payee (or their payment
          service provider) having a backend integration to reach a <a>Token
          Service Provider</a>. The payee expects to retrieve token,
          cryptogram, and other information through backend APIs and therefore
          only needs a reference via Payment Request API. In other words, the
          existence of the backend integration means the payee requires less
          data than with <code>tokenized-card</code>.
        </dd>
        <dt>
          token-cryptogram
        </dt>
        <dd>
          This payment method is for card-on-file use cases when the payee (or
          their payment service provider) already has a token. The payee only
          requires a new cryptogram for a subsequent transaction with the same
          token. For this payment method, we assume the payee (or their payment
          service provider) does <code>not</code> have a backend integration
          that enables them to reach a <a>Token Service Provider</a> for the
          cryptogram. Through this payment method, the payee leverages Payment
          Request API and the user's Payment Handler to reach the original
          <a>Token Service Provider</a>.
        </dd>
      </dl>
    </section>
    <section id="assumptions">
      <h2>
        Assumptions
      </h2>
      <ul>
        <li>A payment handler MUST be able to access the services of one or
        more <a>Token Service Providers</a>.
        </li>
        <li>A payee that uses Payment Request API is registered with its
        <a data-link-for="TokenizedCardRequest">supportedNetworks</a>. This
        specification does not address that registration process.
        </li>
      </ul>
    </section>
    <section id="tokenized-card">
      <h2>
        Tokenized-Card Payment Method
      </h2>
      <p>
        The <a>payment method identifier</a> string for the Tokenized Card
        Payment method is <dfn><code>tokenized-card</code></dfn>.
      </p>
      <section data-dfn-for="TokenizedCardRequest" data-link-for=
      "TokenizedCardRequest">
        <h2>
          <dfn>TokenizedCardRequest</dfn> dictionary
        </h2>
        <p>
          This section describes payment method specific data that is supplied
          as part of the <code>data</code> argument to the PaymentRequest
          constructor.
        </p>
        <pre class="idl">
        dictionary TokenizedCardRequest{
          sequence&lt;DOMString&gt;       supportedNetworks;
          sequence&lt;BasicCardType&gt;   supportedTypes;
          sequence&lt;DOMString&gt; supportedCryptogramTypes;
          required DOMString              keyProviderURL;
                   TokenUsageType         usageType;
                   DOMString              payeeID;
        };
      </pre>
        <p>
          The <code>TokenizedCardRequest</code> dictionary contains the
          following members:
        </p>
        <dl>
          <dt>
            <dfn>supportedNetworks</dfn> member
          </dt>
          <dd>
            A sequence of identifiers for card networks that the payee accepts.
            W3C maintains a <a data-cite="card-network-ids">list of approved
            card network identifiers</a>.
          </dd>
          <dt>
            <dfn>supportedTypes</dfn> member
          </dt>
          <dd>
            A card can be of type "credit", "debit", or "prepaid", as derived
            from the issuer identification number (the first eight digits of
            the <a>primary account number</a> (PAN). The different types are
            represented as the <a>BasicCardType</a> enum.
          </dd>
          <dt>
            <dfn>supportedCryptogramTypes</dfn> member
          </dt>
          <dd>
            This member is an optional list of <a>Payment Network</a>-specific
            strings, each one a <dfn>cryptogramType</dfn>. This list describes
            the types of <a>Token Cryptogram</a> accepted by the payee.
          </dd>
          <dt>
            <dfn>usageType</dfn> member
          </dt>
          <dd>
            A payee may request a <a>TokenUsageType</a>. If not present, the
            value of this member defaults to "one-time".
          </dd>
          <dt>
            <dfn>payeeID</dfn> member
          </dt>
          <dd>
            This Member is an optional <a>Payment Network</a>-specific string
            that the <a>Token Service Provider</a> may use to constrain the
            token for us by a single party. This is called a "merchant
            identifier" in the EMVCO Tokenization Specification.
          </dd>
          <dt>
            <dfn>keyProviderURL</dfn> member
          </dt>
          <dd>
            This member designates, via a URL, a public key trusted by the
            <a>Token Service Provider</a>. The source of the key, therefore,
            becomes the effective requestor of the tokenized-card from a
            <a>Token Service Provider</a>'s perspective.
            <p class="issue" title=
            "What public key formats are acceptable, and any constraints?">
              See <a href=
              "https://github.com/w3c/webpayments-crypto/issues/1">What public
              key formats are acceptable, and any constraints? #1</a> .
            </p>
          </dd>
        </dl>
        <p class="issue" data-number="45"></p>
      </section>
      <section data-dfn-for="TokenUsageType" data-link-for="TokenUsageType">
        <h2>
          <dfn>TokenUsageType</dfn> enum
        </h2>
        <pre class="idl">
          enum TokenUsageType { "one-time", "card-on-file", "recurring" };
        </pre>
        <dl>
          <dt>
            "<dfn>one-time</dfn>"
          </dt>
          <dd>
            The payee expects to use the token for a single authorization. How
            exactly the payee can use the token (e.g., for a charge, an update
            to the authorization, a partial refund, a second partial shipment,
            or incremental charges) is outside the scope of this specification.
          </dd>
          <dt>
            "<dfn>card-on-file</dfn>"
          </dt>
          <dd>
            The payee expects to re-use the token for as yet uknown future
            transactions, including payer-initiated transactions and
            payee-initiated transactions (e.g., for partial shipment,
            incremental charges, and resubmission use cases).
          </dd>
          <dt>
            "<dfn>recurring</dfn>"
          </dt>
          <dd>
            The payee expects to re-use the token exclusively for a recurring
            payment according to an agreement with the payer.
          </dd>
        </dl>
      </section>
      <section data-dfn-for="TokenizedCardResponse" data-link-for=
      "TokenizedCardResponse">
        <h2>
          <dfn>TokenizedCardResponse</dfn> dictionary
        </h2>
        <pre class="idl">
        dictionary TokenizedCardResponse {
                       DOMString       cardholderName;
                       DOMString       displayMaskedCard;
                       DOMString       displayLast4;
           required    DOMString       displayExpiryMonth;
           required    DOMString       displayExpiryYear; 
           required    DOMString       displayNetwork;
                       DOMString       par;
                       DOMString       tokenReferenceID;
                       PaymentAddress? billingAddress;
           required    DOMString       encryptedDetails;
         };
      </pre>
        <dl>
          <dt>
            <dfn>cardholderName</dfn> member
          </dt>
          <dd>
            The <a>card holder's name</a> as it appears on the <a>card</a>.
          </dd>
          <dt>
            <dfn>displayLast4</dfn> member
          </dt>
          <dd>
            It is common for applications to want to display recognizable
            information about the user's card, without revealing sensitive
            credentials. This value may be used as a hint, for the common case
            of displaying the last four digits of the original PAN.
          </dd>
          <dt>
            <dfn>displayMaskedCard</dfn> member
          </dt>
          <dd>
            In some cases, the card issuer may provide an alternative hint to
            <a>displayLast4</a>. Applications MAY use either
            <a>displayLast4</a> or <a>displayMaskedCard</a> as a hint, and
            SHOULD use only one of them to avoid confusion or leaking
            information.
          </dd>
          <dt>
            <dfn>displayExpiryMonth</dfn> member
          </dt>
          <dd>
            A two-digit string for the actual expiry month of the card in the
            range "01" to "12".
          </dd>
          <dt>
            <dfn>displayExpiryYear</dfn> member
          </dt>
          <dd>
            A four-digit string for the expiry year of the actual card in the
            range "0000" to "9999".
          </dd>
          <dt>
            <dfn>displayNetwork</dfn> member
          </dt>
          <dd>
            The name of the actual <a>Payment Network</a> of the card.
          </dd>
          <dt>
            <dfn>billingAddress</dfn> member
          </dt>
          <dd>
            A <a>PaymentAddress</a> that represents the <a>billing address</a>
            associated with the <a>card</a>, or null.
          </dd>
          <dt>
            <dfn>par</dfn> member
          </dt>
          <dd>
            This optional member is a <a>Payment Account Reference</a> (or
            <abbr>PAR</abbr>), which enables merchants, acquirers and payment
            processors to link transactions initiated with affiliated Payment
            Tokens to transactions based on the underlying <a>primary account
            number</a>. The value is a composite field consisting of 29
            uppercase alphanumeric roman characters. See [[EMVCO-TOKENIZATION]]
            for more details.
          </dd>
          <dt>
            <dfn>tokenReferenceID</dfn> member
          </dt>
          <dd>
            This optional member is a <a>Token Reference ID</a>, a substitute
            for the <a data-lt=
            "EncryptedTokenizedCard.cardNumber">cardNumber</a> that does not
            expose information about the <a data-lt=
            "EncryptedTokenizedCard.cardNumber">cardNumber</a> or the
            underlying <a>primary account number</a>. It is a <a>Payment
            Network</a>-specific string.
          </dd>
          <dt>
            <dfn>encryptedDetails</dfn> member
          </dt>
          <dd>
            This member is a string that represents
            <a>EncryptedTokenizedCard</a> information, encrypted with the
            <a data-lt="TokenizedCardRequest.keyProviderURL">keyProviderURL</a>
            according to [[webpayments-crypto]].
          </dd>
        </dl>
        <section data-dfn-for="EncryptedTokenizedCard" data-link-for=
        "EncryptedTokenizedCard">
          <h2>
            <dfn>EncryptedTokenizedCard</dfn> dictionary
          </h2>
          <p>
            This dictionary defines the sensitive data that is to be encrypted.
            Note that the fields of this dictionary do not themselves influence
            the encryption.
          </p>
          <p class="issue" title=
          "Should encryption of tokenized card payment data be optional?"
          data-number="39"></p>
          <pre class="idl">
          dictionary EncryptedTokenizedCard {
           required DOMString       cardNumber;
           required DOMString       expiryMonth;
           required DOMString       expiryYear;
           required DOMString       cryptogram;
                    DOMString       typeOfCryptogram;
                    DOMString       trid;
                    DOMString       eci;
          };
        </pre>
          <dl>
            <dt>
              <dfn>cardNumber</dfn> member
            </dt>
            <dd>
              This member is a <a>Payment Token</a>.
            </dd>
            <dt>
              <dfn>expiryMonth</dfn> member
            </dt>
            <dd>
              A two-digit string of dynamic data in the range "01" to "12";
              this does not represent the actual expiry month of the card.
            </dd>
            <dt>
              <dfn>expiryYear</dfn> member
            </dt>
            <dd>
              A four-digit string of dynamic data in the range "0000" to
              "9999"; this does not represent the actual expiry year of the
              card.
            </dd>
            <dt>
              <dfn>cryptogram</dfn> member
            </dt>
            <dd>
              This member is a <a>Token Cryptogram</a>. It is <a>Payment
              Network</a>-specific and used to ensure the authenticity of the
              transaction.
            </dd>
            <dt>
              <dfn>typeOfCryptogram</dfn> member
            </dt>
            <dd>
              This member is a <a>Payment Network</a>-specific string that
              describes the <a>Token Cryptogram</a> type.
            </dd>
            <dt>
              <dfn>trid</dfn> member
            </dt>
            <dd>
              This member is a <a>Token Requestor ID</a>, an 11-digit numeric
              value that identifies the token requestor (e.g., the <a>payment
              handler</a>) and is used as part of authorization flows.
            </dd>
            <dt>
              <dfn>eci</dfn> member
            </dt>
            <dd>
              This member is an <a>Electronic Commerce Indicator</a>, a
              <a>Payment Network</a>-specific string to indicate the results of
              user authentication.
            </dd>
          </dl>
        </section>
      </section>
    </section>
    <section id="token-reference">
      <h2>
        Token-Reference Payment Method
      </h2>
      <p>
        The <a>payment method identifier</a> string for the Token Reference
        Payment method is <dfn><code>token-reference</code></dfn>.
      </p>
      <p class="issue" data-number="46"></p>
      <section data-dfn-for="TokenReferenceRequest" data-link-for=
      "TokenReferenceRequest">
        <h2>
          <dfn>TokenReferenceRequest</dfn> dictionary
        </h2>
        <p>
          This section describes payment method specific data that is supplied
          as part of the <code>data</code> argument to the PaymentRequest
          constructor.
        </p>
        <pre class="idl">
        dictionary TokenReferenceRequest{
          sequence&lt;DOMString&gt;       supportedNetworks;
          sequence&lt;BasicCardType&gt;   supportedTypes;
          sequence&lt;DOMString&gt; supportedCryptogramTypes;
                   TokenUsageType         usageType;
                   DOMString              payeeID;
        };
      </pre>
        <p data-link-for="TokenizedCardRequest">
          The <code>TokenReferenceRequest</code> dictionary reuses the
          following members from the <a>TokenizedCardRequest</a> dictionary:
          <a>supportedNetworks</a>, <a>supportedTypes</a>,
          <a>supportedCryptogramTypes</a>, <a>usageType</a>, and
          <a>payeeID</a>.
        </p>
      </section>
      <section data-dfn-for="TokenReferenceResponse" data-link-for=
      "TokenReferenceResponse">
        <h2>
          <dfn>TokenReferenceResponse</dfn> dictionary
        </h2>
        <pre class="idl">
        dictionary TokenReferenceResponse {
                  required DOMString       tokenReferenceID;
         };
              </pre>
        <dl>
          <dt>
            <dfn>tokenReferenceID</dfn> member
          </dt>
          <dd>
            This member is a <a>Payment Network</a>-specific <a>Token Reference
            ID</a> that the payee uses on the backend to retrieve additional
            information about the card.
          </dd>
        </dl>
      </section>
    </section>
    <section id="token-cryptogram">
      <h2>
        Token-Cryptogram Payment Method
      </h2>
      <p>
        The <a>payment method identifier</a> string for the Token Cryptogram
        Payment method is <dfn><code>token-cryptogram</code></dfn>.
      </p>
      <p class="issue" data-number="44"></p>
      <section data-dfn-for="TokenCryptogramRequest" data-link-for=
      "TokenCryptogramRequest">
        <h2>
          <dfn>TokenCryptogramRequest</dfn> dictionary
        </h2>
        <p>
          This section describes payment method specific data that is supplied
          as part of the <code>data</code> argument to the PaymentRequest
          constructor.
        </p>
        <pre class="idl">
        dictionary TokenCryptogramRequest{
           required DOMString   tokenRequestorID;
           required DOMString   tokenReferenceID;
        };
      </pre>
        <p>
          The <code>TokenCryptogramRequest</code> dictionary contains the
          following members:
        </p>
        <dl>
          <dt>
            <dfn>tokenRequestorID</dfn> member
          </dt>
          <dd>
            This member identifies the payment handler used to request the
            original token. It is an 11-digit numeric value that is a <a>Token
            Requestor ID</a>. The user agent uses this information to provide a
            path to the <a>Token Service Provider</a> through the payment
            handler that requested the original token. It is assumed that the
            payment handler also has a means to validate that the payee
            requesting the cryptogram is authorized to do so (e.g., using
            <a>origin</a> information).
          </dd>
          <dt>
            <dfn>tokenReferenceID</dfn> member
          </dt>
          <dd>
            This member is a <a>Payment Network</a>-specific <a>Token Reference
            ID</a> that represents the stored token for which the payee is
            requesting a new cryptogram.
          </dd>
        </dl>
      </section>
      <section data-dfn-for="TokenCryptogramResponse" data-link-for=
      "TokenCryptogramResponse">
        <h2>
          <dfn>TokenCryptogramResponse</dfn> dictionary
        </h2>
        <pre class="idl">
          dictionary TokenCryptogramResponse{
               required DOMString cryptogram;
        };
      </pre>
        <dl>
          <dt>
            <dfn>cryptogram</dfn> member
          </dt>
          <dd>
            This member is a <a>Token Cryptogram</a>.
          </dd>
        </dl>
      </section>
    </section>
    <section id="interfacing">
      <h2>
        Interfacing with a payment request for tokenized-card
      </h2>
      <p class="note">
        Currently these sections are for the <code>tokenized-card</code>
        payment method; we will need similar algorithms for other payment
        methods.
      </p>
      <section>
        <h3>
          Steps to check if a payment can be made
        </h3>
        <p>
          The <dfn>steps to check if a payment can be made</dfn> by a Payment
          Handler that handles "tokenized-card" takes
          <a>TokenizedCardRequest</a> <var>request</var> as input. It returns
          either true or false:
        </p>
        <ol class="algorithm">
          <li>Let <var>cards</var> be a <a data-cite="infra#list">list</a> of
          <a>cards</a> associated with this payment handler.
          </li>
          <li>If <var>cards</var> <a data-cite="infra#list-is-empty">is
          empty</a>, return false.
          </li>
          <li>Let <var>networks</var> be an empty <code><a data-cite=
          "!WEBIDL#idl-DOMString">DOMString</a></code> sequence.
          </li>
          <li>Let <var>types</var> be an empty <a>BasicCardType</a> sequence.
          </li>
          <li>Let <var>cryptograms</var> be an empty <code><a data-cite=
          "!WEBIDL#idl-DOMString">DOMString</a></code> sequence.
          </li>
          <li>Let <var>usage</var> be the value of
          <var>request</var>["usageType"] if present, otherwise set it to
          "one-time". If the value of <var>usage</var> is not a legal value of
          <a>TokenUsageType</a>, set <var>usage</var> to "one-time".
          </li>
          <li>If <var>request</var>["supportedTypes"] is present, append each
          item in <var>request</var>["supportedTypes"] to <var>types</var>.
          </li>
          <li>If <var>request</var>["supportedNetworks"] is present, append
          each item in <var>request</var>["supportedNetworks"] to
          <var>networks</var>.
          </li>
          <li>If <var>request</var>["supportedCryptogramTypes"] is present,
          append each item in <var>request</var>["supportedCryptogramTypes"] to
          <var>cryptograms</var>.
          </li>
          <li>For each <var>card</var> in <var>cards</var>:
            <ol>
              <li>Let <var>isSupported</var> be the result of running the
              <a>steps to check if an instrument is supported</a>, passing in
              <var>card</var>, <var>networks</var>, <var>types</var>,
              <var>cryptograms</var>, <var>usage</var>
              </li>
              <li>If <var>isSupported</var> is true, then return true.
              </li>
            </ol>
          </li>
          <li>Return false.
          </li>
        </ol>
      </section>
      <section>
        <h3>
          Steps to check if an instrument is supported
        </h3>
        <p>
          The <dfn>steps to check if an instrument is supported</dfn> takes as
          input a <a>card</a> <var>card</var>, a <a data-cite=
          "infra#list">list</a> of <a>type</a> <var>types</var>, a
          <a data-cite="infra#list">list</a> of <a>network</a>
          <var>networks</var>, a <a data-cite="infra#list">list</a> of
          <a>cryptogramType</a> <var>cryptograms</var> and a <a data-link-for=
          "TokenizedCardRequest">usageType</a> <var>usage</var>. It returns
          true if the <var>card</var> is supported, false otherwise.
        </p>
        <ol class="algorithm">
          <li>If <var>types</var> <a data-cite="!infra#list-is-empty">is
          empty</a> and <var>networks</var> <a data-cite=
          "!infra#list-is-empty">is empty</a>, return true.
          </li>
          <li>If <var>networks</var> <a data-cite="!infra#list-is-empty">is not
          empty</a>:
            <ol>
              <li>If <var>networks</var> does not include the <a>card</a>'s <a>
                network</a>, return false.
              </li>
            </ol>
          </li>
          <li>If <var>types</var> <a data-cite="!infra#list-is-empty">is not
          empty</a>:
            <ol>
              <li>If <var>types</var> does not include the <a>card</a>'s
              <a>type</a>, return false.
              </li>
            </ol>
          </li>
          <li>If <var>cryptograms</var> <a data-cite="!infra#list-is-empty">is
          not empty</a>:
            <ol>
              <li>If <var>cryptograms</var> does not include a
              <a>cryptogramType</a> supported by the <a>payment handler</a>,
              return false.
              </li>
            </ol>
          </li>
          <li>If <var>usage</var> is not supported by the <a>payment
          handler</a>, return false.
          </li>
          <li>Return true.
          </li>
        </ol>
      </section>
      <section>
        <h3>
          Steps to respond to a payment request
        </h3>
        <p>
          The <dfn>steps to respond to a payment request</dfn> are given by the
          following algorithm. If the end user inputs or selects a <a>card</a>
          that meets the constraints of <a>TokenizedCardRequest</a>
          <var>data</var>, the algorithm returns a card as a
          <a>TokenizedCardResponse</a>.
        </p>
        <ol class="algorithm" data-link-for="TokenizedCardResponse">
          <li data-link-for="TokenizedCardRequest">Let <var>networks</var> be
          <var>data</var>["<a>supportedNetworks</a>"], or an empty list if
          <var>data</var>["<a>supportedNetworks</a>"] is missing.
          </li>
          <li data-link-for="TokenizedCardRequest">Let <var>types</var> be
          <var>data</var>["<a>supportedTypes</a>"], or an empty list if
          <var>data</var>["<a>supportedTypes</a>"] is missing.
          </li>
          <li data-link-for="TokenizedCardRequest">Let <var>key</var> be the
          result of fetching <var>data</var>["<a>keyProviderURL</a>"]. In case
          of an error, throw throw an error abort these steps.
          </li>
          <li>Let <var>card</var> be a <a>TokenizedCardResponse</a>.
          </li>
          <li>Set <var>card</var>["<a>cardholderName</a>"] to the <a>card
          holder's name</a>, or the empty string if the user chooses not to
          provide it.
          </li>
          <li>To provide a hint to help the user select this <a>card</a>,
          either set <var>card</var>["<a>displayLast4</a>"] to a string that
          includes the last four digits of the <a>primary account number</a>
          (e.g., "*** 5050") or set <var>card</var>["<a>displayMaskedCard</a>"]
          to a string that represents different non-sensitive information about
          the card (e.g., "Francine Business").
          </li>
          <li>Set <var>card</var>["<a>displayExpiryMonth</a>"] to two-digit
          string ranging from "<code>01</code>" to "<code>12</code>", or the
          empty string if the user chooses not to provide it or the <a>type</a>
          doesn't require an expiry month.
          </li>
          <li>Set <var>card</var>["<a>displayExpiryYear</a>"] to a four-digit
          string in the range "<code>0000</code>" to "<code>9999</code>", or
          the empty string if the user chooses not to provide it or the
          <a>type</a> doesn't require an expiry year.
          </li>
          <li>Set <var>card</var>["<a>displayNetwork</a>"] to a string that
          identifies the card <a>network</a>.
          </li>
          <li>Set <var>card</var>["<a>par</a>"] to a 29-character string, or
          the empty string if not available.
          </li>
          <li>Set <var>card</var>["<a>tokenReferenceID</a>"] to a <a>Token
          Reference ID</a> string, or the empty string if not available.
          </li>
          <li>If a billing address is not required for this card <a>type</a>,
          then set <var>card</var>["<a>billingAddress</a>"] to null. Otherwise:
            <ol>
              <li>Let <var>redactList</var> be « "phone" ».
              </li>
              <li>Let <var>billingAddress</var> be the result running the steps
              to <a data-cite=
              "payment-request#dfn-create-a-payment-address">create a
              <code>PaymentAddress</code> from user-provided input</a> with
              <var>redactList</var>.
              </li>
              <li>Set <var>card</var>["<a>billingAddress</a>"] to
              <var>billingAddress</var>.
              </li>
            </ol>
          </li>
          <li>Set <var>cardNumber</var> to a tokenized representation of
          <a>primary account number</a>, a string of digits that ranges from 10
          to 19 digits.
          </li>
          <li>Set <var>expiryYear</var> to two-digit string ranging from
          "<code>01</code>" to "<code>12</code>", or the empty string if the
          user chooses not to provide it or the <a>type</a> doesn't require an
          expiry month.
          </li>
          <li>Set <var>expiryMonth</var> to a four-digit string in the range
          "<code>0000</code>" to "<code>9999</code>", or the empty string if
          the user chooses not to provide it or the <a>type</a> doesn't require
          an expiry year.
          </li>
          <li>Set <var>cryptogram</var> to a <a>Token Cryptogram</a>, a
          <a>Payment Network</a>-specific string.
          </li>
          <li>Set <var>typeOfcryptogram</var> to a <a>Payment
          Network</a>-specific string that represents the type of the
          <var>cryptogram</var>.
          </li>
          <li>Set <var>trid</var> to a <a>Token Requestor ID</a>, an 11-digit
          numeric value.
          </li>
          <li>Set <var>eci</var> to <a>Electronic Commerce Indicator</a>, a <a>
            Payment Network</a>-specific string.
          </li>
          <li>Set <var>card</var>["<a>encryptedDetails</a>"] to a string
          following the <a>steps for response data encryption</a>, where the
          <a>content encryption key</a> is set to <var>key</var> and the
          <a>plaintext encryption</a> algorithm takes as input
          <var>cardNumber</var>, <var>expiryMonth</var>, <var>expiryYear</var>,
          <var>cryptogram</var>, <var>typeOfcryptogram</var>, <var>trid</var>,
          and <var>eci</var>.
          </li>
          <li>Return <var>card</var>.
          </li>
        </ol>
        <p class="note" title="Validation">
          Until such time as we learn of intention by browsers/mediators to
          implement this specification, we have eliminated discussion of
          validation in this algorithm.
        </p>
        <p class="issue" data-number="43"></p>
      </section>
    </section>
    <section id="conformance">
      <p>
        There is only one class of product that can claim conformance to this
        specification: a <dfn>payment handler</dfn>.
      </p>
      <p>
        A conforming <a>payment handler</a> MUST:
      </p>
      <ul>
        <li data-tests=
        "payment-method-basic-card/payment-request-canmakepayment-method.https.html">
        when queried, claim to support the "<a>tokenized-card</a>"
        <a>standardized payment method identifier</a>.
        </li>
        <li data-tests=
        "payment-method-basic-card/basiccardresponse-member-formats-manual.https.html">
        return <a>TokenizedCardResponse</a>s whose members are formatted per
        their definition in this specification.
        </li>
      </ul>
    </section>
    <section id="security">
      <h2>
        Security and Privacy Considerations
      </h2>
      <p class="issue" title="Document threat model" data-number="36"></p>
    </section>
    <section id="dependencies">
      <h2>
        Dependencies
      </h2>
      <p>
        This specification relies on several other underlying specifications.
      </p>
      <dl>
        <dt>
          Payment Request API
        </dt>
        <dd>
          The terms <dfn>PaymentAddress</dfn> and <dfn>PaymentRequest
          constructor</dfn> are defined in Payment Request API
          [[payment-request]].
        </dd>
        <dt>
          Payment Method Identifiers
        </dt>
        <dd>
          The term <dfn data-lt="payment method identifiers">payment method
          identifier</dfn> and <dfn>standardized payment method
          identifier</dfn> are defined by the Payment Method Identifier
          specification [[!payment-method-id]].
        </dd>
        <dt>
          Basic Card Payment
        </dt>
        <dd>
          The terms <dfn data-cite=
          "!payment-method-basic-card#method-id">basic-card</dfn>,
          <dfn data-cite=
          "!payment-method-basic-card#basiccardtype-enum">BasicCardType</dfn>,
          <dfn data-lt="card" data-cite=
          "!payment-method-basic-card#cards">cards</dfn>, <dfn data-cite=
          "!payment-method-basic-card#type">type</dfn>, <dfn data-lt="network"
          data-cite="!payment-method-basic-card#networks">networks</dfn>,
          <dfn data-cite=
          "!payment-method-basic-card#networks">primary-account-number</dfn>,
          <dfn data-cite="!payment-method-basic-card#billingaddress">billing
          address</dfn>, and <dfn data-cite=
          "!payment-method-basic-card#cardholder&quot;sname">card holder's
          name</dfn> are defined in [[!payment-method-basic-card]].
        </dd>
        <dt>
          EMVCo Tokenisation
        </dt>
        <dd>
          The terms <dfn data-cite="!EMVCO-TOKENIZATION">Payment Token</dfn>,
          <dfn data-cite="EMVCO-TOKENIZATION">Token Cryptogram</dfn>,
          <dfn data-lt="Payment Network" data-cite="EMVCO-TOKENIZATION">Payment
          Networks</dfn>, <dfn data-lt="Token Service Provider" data-cite=
          "EMVCO-TOKENIZATION">Token Service Providers</dfn>, <dfn data-cite=
          "EMVCO-TOKENIZATION">Token Requestor ID</dfn>, <dfn data-cite=
          "EMVCO-TOKENIZATION">Token Requestor</dfn>, <dfn data-cite=
          "EMVCO-TOKENIZATION">Merchant Identifier</dfn> and <dfn data-cite=
          "EMVCO-TOKENIZATION">Tokenized Payment Method Credentials</dfn>,
          <dfn data-cite="EMVCO-TOKENIZATION">Token Reference ID</dfn>, and
          <dfn data-cite="EMVCO-TOKENIZATION">Payment Account Reference</dfn>
          are defined in [[EMVCO-TOKENIZATION]].
        </dd>
        <dt>
          EMVCo 3-D Secure
        </dt>
        <dd>
          The terms <dfn data-cite="!EMVCO-3DS">Electronic Commerce
          Indicator</dfn> is defined in [[EMVCO-3DS]].
        </dd>
        <dt>
          Payment Method Encryption
        </dt>
        <dd>
          The <dfn>steps for response data encryption</dfn> are described in
          [[!webpayments-crypto]]. That specification defines the terms
          <dfn data-cite="!webpayments-crypto#key">content encryption
          key</dfn>, <dfn data-cite="!webpayments-crypto#message">message
          structure</dfn>, and <dfn data-cite=
          "!webpayments-crypto#plaintext-encryption">plaintext
          encryption</dfn>.
        </dd>
        <dt>
          RFC6454
        </dt>
        <dd>
          The term <dfn>origin</dfn> is defined in [[!RFC6454]].
        </dd>
        <dt>
          ISO7812-1
        </dt>
        <dd>
          ISO 7812-1 specifies a numbering system for the identification of the
          card issuers, the format of the issuer identification number (IIN)
          and the <dfn data-cite="ISO7812-1">primary account number</dfn>
          (PAN).
        </dd>
      </dl>
    </section>
    <section id="tsp-considerations" class="informative">
      <h2>
        Appendix: Token Service Provider Considerations
      </h2>
      <p>
        The following <a>Token Service Provider</a> considerations are
        explicitly out of scope for this specification.
      </p>
      <ul>
        <li>This specification focuses on standardizing data from an arbitrary
        payment handler at transaction time. How provisioning takes place lies
        outside the scope of this specification.
        </li>
        <li>Any requirement for a KeyProvider to register/onboard with a Token
        Service Provider, for example to establish cryptogram conventions or
        other program-specific requirements.
        </li>
      </ul>
      <p class="issue" title="Out-of-band provisioning" data-number="32"></p>
      <p class="issue" title="Key Provider Registration" data-number="31"></p>
    </section>
    <section id="acks">
      <h2>
        Acknowledgments
      </h2>
      <p>
        Thanks to Manash Bhattacharjee for his early work on this
        specification.
      </p>
    </section>
  </body>
</html>
